rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Conversations: only participants can read/write
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null
        && request.auth.uid in resource.data.participants;
    }

    // Messages: top-level messages collection
    // Only participants of the related conversation can read or create
    match /messages/{messageId} {
      // Helper: get related conversation
      function isParticipant() {
        return request.auth != null
          && exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId))
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.participants;
      }

      // Read only if the authed user participates in that conversation
      allow read: if request.auth != null
        && resource.data.conversationId != null
        && exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId))
        && request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;

      // Create only by participants; restrict fields
      allow create: if isParticipant()
        && request.resource.data.keys().hasAll([
          'conversationId', 'senderId', 'senderName', 'text', 'timestamp', 'read'
        ])
        && request.resource.data.conversationId is string
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() <= 2000; // Optional length limit

      // Updates (e.g., setting read=true) can be allowed for participants
      allow update: if isParticipant();

      // Delete: optional; restrict to server-side only (deny clients)
      allow delete: if false;
    }

    // Posts remain readable for all authed users
    match /posts/{postId} {
      allow read: if request.auth != null;
      // Write rules can be tightened as needed
      allow create, update, delete: if request.auth != null && request.auth.uid == request.resource.data.authorId;
    }

    // Claims: only involved users
    match /claims/{claimId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
